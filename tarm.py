from roputils import ROP_util
from rop_platform import Platform

import time

if __name__ == "__main__":

    bin = "/lib/aarch64-linux-gnu/libc.so.6"

    print(f"======= running roputils.py test =======")

    t = time.time()

    r = ROP_util(bin, Platform.ARM64)    
    r.scout_for_gadgets()

    for ef in ["LOAD_S", "LOAD_CT", "MOV_RR", "ARITH", "JUMP"]:
        for reg in r.platform.SUPPORTED_REGS:
            print(f"{ef}, out reg {reg}: {len(r.rop_searcher.effects_to_gadgets[ef][reg])}")

    r.rop_searcher.valid_stats()

    mov_r_sp_cnt = 0

    for g in r.rop_searcher.gadgets:
        for ef in g.effects:
            if ef.type == "MOV_RR" and ef.params[0].info["reg_name"] == "sp":

                mov_r_sp_cnt += 1

    print(f"[MOV reg, sp] count: {mov_r_sp_cnt}")